apiVersion: batch/v1
kind: Job
metadata:
  name: job-quarkgluon-download
  namespace: model-dev
  labels:
    tier: jobs
    dataset: quarkgluon
spec:
  backoffLimit: 2
  template:
    spec:
      restartPolicy: OnFailure
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - ucsd
      containers:
      - name: download
        image: alpine:3.20
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -eu
          apk add --no-cache aria2 tar
          
          DEST="/mnt/datasets/QuarkGluon"
          URL="https://hqu.web.cern.ch/datasets/QuarkGluon/QuarkGluon.tar"
          MD5="d8dd7f71a7aaaf9f1d2ee3cddef998f9"
          
          mkdir -p "$DEST"
          echo "[INFO] Downloading QuarkGluon.tar..."
          aria2c -c -x16 -s16 -k1M --checksum="md5=$MD5" -d "$DEST" -o "QuarkGluon.tar" "$URL"
          
          echo "[INFO] Extracting..."
          tar -xf "$DEST/QuarkGluon.tar" -C "$DEST" && rm -f "$DEST/QuarkGluon.tar"
          
          echo "[DONE] QuarkGluon dataset ready at $DEST"
        volumeMounts:
        - name: datasets
          mountPath: /mnt/datasets
        resources:
          requests:
            cpu: "2"
            memory: "4Gi"
          limits:
            cpu: "4"
            memory: "8Gi"
      volumes:
      - name: datasets
        persistentVolumeClaim:
          claimName: infra-datasets-pvc
